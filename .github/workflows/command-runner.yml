name: Command Runner

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: read

jobs:
  run:
    if: ${{ github.event.issue.pull_request == null && github.event.issue.number == 1 }}
    runs-on: ubuntu-latest

    steps:
      - name: Guard: actor + token + allowlist command
        id: guard
        env:
          BODY: ${{ github.event.comment.body }}
          TOKEN: ${{ secrets.CMD_TOKEN }}
          ACTOR: ${{ github.actor }}
          ALLOWED_ACTOR: hbghbjhjn
        run: |
          set -euo pipefail

          if [ "$ACTOR" != "$ALLOWED_ACTOR" ]; then
            echo "Unauthorized actor: $ACTOR"
            exit 1
          fi

          if ! printf "%s" "$BODY" | grep -qE '^RUN [a-zA-Z0-9_\-]+ TOKEN='; then
            echo "Bad format. Use: RUN <command> TOKEN=<token>"
            exit 1
          fi

          CMD="$(printf "%s" "$BODY" | awk '{print $2}')"
          PROVIDED="$(printf "%s" "$BODY" | sed -n 's/.*TOKEN=\(.*\)$/\1/p' | tr -d '\r')"

          if [ "$PROVIDED" != "$TOKEN" ]; then
            echo "Bad token"
            exit 1
          fi

          case "$CMD" in
            init_android|build_apk|apply_patch)
              echo "cmd=$CMD" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Command not allowed: $CMD"
              exit 1
              ;;
          esac

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        if: ${{ steps.guard.outputs.cmd == 'build_apk' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Download Gradle distribution and VERIFY authenticity (checksum) before using it.
      - name: Install Gradle (verified)
        if: ${{ steps.guard.outputs.cmd == 'build_apk' }}
        env:
          GRADLE_VERSION: "8.2"
        run: |
          set -euo pipefail

          ZIP="gradle-${GRADLE_VERSION}-bin.zip"
          URL="https://services.gradle.org/distributions/${ZIP}"
          SHA_URL="${URL}.sha256"

          echo "Downloading Gradle: $URL"
          curl -fsSL "$URL" -o "$ZIP"

          echo "Downloading checksum: $SHA_URL"
          curl -fsSL "$SHA_URL" -o "${ZIP}.sha256"

          # Verify authenticity: zip hash must match published hash
          sha256sum -c "${ZIP}.sha256"

          echo "Checksum OK. Unzipping..."
          unzip -q "$ZIP" -d "$HOME/.gradle-dist"

          echo "$HOME/.gradle-dist/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH
          gradle --version

      - name: Run command
        env:
          CMD: ${{ steps.guard.outputs.cmd }}
          BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          chmod +x commands/*.sh

          case "$CMD" in
            init_android)
              commands/init_android.sh
              ;;
            build_apk)
              commands/build_apk.sh
              ;;
            apply_patch)
              commands/apply_patch.sh
              ;;
          esac

      - name: Commit changes (if any)
        run: |
          set -e
          git config user.name "command-runner"
          git config user.email "command-runner@users.noreply.github.com"

          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "Command Runner: apply ${{ steps.guard.outputs.cmd }}"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload APK artifact (if exists)
        if: ${{ steps.guard.outputs.cmd == 'build_apk' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
